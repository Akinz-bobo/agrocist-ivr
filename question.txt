Now another bug, I heard thank you for your question, agrocist is analysing my concern, please wait a moment for your response, and then the call got hanged up
[nodemon] restarting due to changes...
[nodemon] starting `ts-node src/index.ts`
info: ffmpeg detected - audio compression enabled {"service":"agrocist-ivr","timestamp":"2025-10-07T15:27:46.540Z"}
info: TTS Service initialized with DSN API: https://api.dsnsandbox.com {"service":"agrocist-ivr","timestamp":"2025-10-07T15:27:46.544Z"}
info: SessionManager initialized with in-memory storage {"service":"agrocist-ivr","timestamp":"2025-10-07T15:27:46.737Z"}
info: Agrocist IVR server starting on port 3000 {"service":"agrocist-ivr","timestamp":"2025-10-07T15:27:47.043Z"}
info: Environment: development {"service":"agrocist-ivr","timestamp":"2025-10-07T15:27:47.044Z"}
info: Available endpoints: {"service":"agrocist-ivr","timestamp":"2025-10-07T15:27:47.044Z"}
info:   POST /voice - Main voice webhook {"service":"agrocist-ivr","timestamp":"2025-10-07T15:27:47.044Z"}
info:   POST /voice/menu - Menu selections {"service":"agrocist-ivr","timestamp":"2025-10-07T15:27:47.044Z"}
info:   POST /voice/recording - Voice recordings {"service":"agrocist-ivr","timestamp":"2025-10-07T15:27:47.044Z"}
info:   GET /health - Health check {"service":"agrocist-ivr","timestamp":"2025-10-07T15:27:47.045Z"}
info: üî• Starting audio pre-warming in background... {"service":"agrocist-ivr","timestamp":"2025-10-07T15:27:47.045Z"}
info: üî• Starting audio pre-warming process... {"service":"agrocist-ivr","timestamp":"2025-10-07T15:27:47.045Z"}
info: üî• Audio pre-warming completed in 4ms {"service":"agrocist-ivr","timestamp":"2025-10-07T15:27:47.049Z"}
info: ‚úÖ Success: 19, ‚ùå Failed: 0, Total: 19 {"service":"agrocist-ivr","timestamp":"2025-10-07T15:27:47.049Z"}
info: ‚úÖ Audio pre-warming completed - system ready for ultra-fast responses! {"service":"agrocist-ivr","timestamp":"2025-10-07T15:27:47.049Z"}
info: POST /voice {"ip":"::1","service":"agrocist-ivr","timestamp":"2025-10-07T15:28:09.625Z","userAgent":"at-voice-api/1.0"}
info: POST / {"body":{"callSessionState":"Ringing","callStartTime":"2025-10-07 15:28:09","callerCarrierName":"MTN","callerCountryCode":"234","callerNumber":"+2347046713891","destinationNumber":"+2342017001117","direction":"Inbound","isActive":"1","sessionId":"ATVId_b459912a561e10e6fd61fd9e93741d1c"},"headers":{"content-length":"249","content-type":"application/x-www-form-urlencoded","host":"localhost:3000","proxy-connection":"Keep-Alive","user-agent":"at-voice-api/1.0","x-forwarded-for":"18.130.220.110","x-forwarded-host":"turbo-invention-56q6r66j7vc7797-3000.app.github.dev","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-scheme":"https","x-original-uri":"/voice","x-real-ip":"18.130.220.110","x-request-id":"86ef5653a74dda2c64f3a69efca0eb23","x-scheme":"https"},"ip":"::1","service":"agrocist-ivr","timestamp":"2025-10-07T15:28:09.626Z"}
info: === INCOMING WEBHOOK REQUEST === {"service":"agrocist-ivr","timestamp":"2025-10-07T15:28:09.627Z"}
info: Content-Type: application/x-www-form-urlencoded {"service":"agrocist-ivr","timestamp":"2025-10-07T15:28:09.627Z"}
info: Method: POST {"service":"agrocist-ivr","timestamp":"2025-10-07T15:28:09.627Z"}
info: URL: / {"service":"agrocist-ivr","timestamp":"2025-10-07T15:28:09.628Z"}
info: Headers: {"content-length":"249","content-type":"application/x-www-form-urlencoded","host":"localhost:3000","proxy-connection":"Keep-Alive","service":"agrocist-ivr","timestamp":"2025-10-07T15:28:09.628Z","user-agent":"at-voice-api/1.0","x-forwarded-for":"18.130.220.110","x-forwarded-host":"turbo-invention-56q6r66j7vc7797-3000.app.github.dev","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-scheme":"https","x-original-uri":"/voice","x-real-ip":"18.130.220.110","x-request-id":"86ef5653a74dda2c64f3a69efca0eb23","x-scheme":"https"}
info: Full webhook data received: {"service":"agrocist-ivr","timestamp":"2025-10-07T15:28:09.628Z"}
info: PARSED DATA - Session: ATVId_b459912a561e10e6fd61fd9e93741d1c, Active: 1, Caller: +2347046713891, Destination: +2342017001117, Duration: undefineds {"service":"agrocist-ivr","timestamp":"2025-10-07T15:28:09.628Z"}
info: ‚úÖ ACTIVE INCOMING CALL (isActive=1) - generating IVR response {"callerNumber":"+2347046713891","destinationNumber":"+2342017001117","isActive":"1","service":"agrocist-ivr","sessionId":"ATVId_b459912a561e10e6fd61fd9e93741d1c","timestamp":"2025-10-07T15:28:09.628Z"}
info: Created new session: ATVId_b459912a561e10e6fd61fd9e93741d1c for caller: +2347046713891 {"service":"agrocist-ivr","timestamp":"2025-10-07T15:28:09.628Z"}
info: üìù Created session for incoming call: ATVId_b459912a561e10e6fd61fd9e93741d1c {"service":"agrocist-ivr","timestamp":"2025-10-07T15:28:09.628Z"}
info: üì¢ Welcome audio URL: https://turbo-invention-56q6r66j7vc7797-3000.app.github.dev/audio/258090fd95ba09237c5e4a107d4f9950_compressed.mp3 {"service":"agrocist-ivr","timestamp":"2025-10-07T15:28:09.629Z"}
info: üé§ SENDING IVR XML RESPONSE: {"service":"agrocist-ivr","timestamp":"2025-10-07T15:28:09.630Z"}
info: <?xml version="1.0" encoding="UTF-8"?>
<Response>
  <GetDigits timeout="10" finishOnKey="#" callbackUrl="https://turbo-invention-56q6r66j7vc7797-3000.app.github.dev/voice/language">
<Play url="https://turbo-invention-56q6r66j7vc7797-3000.app.github.dev/audio/258090fd95ba09237c5e4a107d4f9950_compressed.mp3"/>
  </GetDigits>
</Response> {"service":"agrocist-ivr","timestamp":"2025-10-07T15:28:09.630Z"}
info: POST /voice/end {"ip":"::1","service":"agrocist-ivr","timestamp":"2025-10-07T15:28:09.736Z","userAgent":"at-voice-api/1.0"}
info: POST /end {"body":{"callSessionState":"Active","callStartTime":"2025-10-07 15:28:09","callerCarrierName":"MTN","callerCountryCode":"234","callerNumber":"+2347046713891","destinationNumber":"+2342017001117","direction":"Inbound","isActive":"1","sessionId":"ATVId_b459912a561e10e6fd61fd9e93741d1c"},"headers":{"content-length":"248","content-type":"application/x-www-form-urlencoded","host":"localhost:3000","proxy-connection":"Keep-Alive","user-agent":"at-voice-api/1.0","x-forwarded-for":"18.130.220.110","x-forwarded-host":"turbo-invention-56q6r66j7vc7797-3000.app.github.dev","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-scheme":"https","x-original-uri":"/voice/end","x-real-ip":"18.130.220.110","x-request-id":"388988bbb714d9a8c4956e66af637b85","x-scheme":"https"},"ip":"::1","service":"agrocist-ivr","timestamp":"2025-10-07T15:28:09.737Z"}
info: POST /voice/language {"ip":"::1","service":"agrocist-ivr","timestamp":"2025-10-07T15:28:32.969Z","userAgent":"at-voice-api/1.0"}
info: POST /language {"body":{"callSessionState":"Active","callStartTime":"2025-10-07 15:28:09","callerCarrierName":"MTN","callerCountryCode":"234","callerNumber":"+2347046713891","destinationNumber":"+2342017001117","direction":"Inbound","dtmfDigits":"1","isActive":"1","sessionId":"ATVId_b459912a561e10e6fd61fd9e93741d1c"},"headers":{"content-length":"261","content-type":"application/x-www-form-urlencoded","host":"localhost:3000","proxy-connection":"Keep-Alive","user-agent":"at-voice-api/1.0","x-forwarded-for":"18.130.220.110","x-forwarded-host":"turbo-invention-56q6r66j7vc7797-3000.app.github.dev","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-scheme":"https","x-original-uri":"/voice/language","x-real-ip":"18.130.220.110","x-request-id":"273555e6fa8de4e883f287b9c378bcb0","x-scheme":"https"},"ip":"::1","service":"agrocist-ivr","timestamp":"2025-10-07T15:28:32.969Z"}
info: === LANGUAGE SELECTION WEBHOOK === {"service":"agrocist-ivr","timestamp":"2025-10-07T15:28:32.970Z"}
info: Full webhook data: {"service":"agrocist-ivr","timestamp":"2025-10-07T15:28:32.970Z"}
info: Language selection - Session: ATVId_b459912a561e10e6fd61fd9e93741d1c, Active: 1, DTMF: 1 {"service":"agrocist-ivr","timestamp":"2025-10-07T15:28:32.971Z"}
info: ‚úÖ Language en LOCKED for session: ATVId_b459912a561e10e6fd61fd9e93741d1c, going directly to recording {"service":"agrocist-ivr","timestamp":"2025-10-07T15:28:32.971Z"}
info: üé§ SENDING LANGUAGE SELECTION RESPONSE: {"service":"agrocist-ivr","timestamp":"2025-10-07T15:28:32.973Z"}
info: <?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Record maxLength="30" trimSilence="true" playBeep="true" finishOnKey="#" callbackUrl="https://turbo-invention-56q6r66j7vc7797-3000.app.github.dev/voice/recording">
    <Play url="https://turbo-invention-56q6r66j7vc7797-3000.app.github.dev/audio/30ecffd8f03b69bdf6fc39ac84bfb8d9_compressed.mp3"/>
  </Record>
</Response> {"service":"agrocist-ivr","timestamp":"2025-10-07T15:28:32.973Z"}
info: POST /voice/recording {"ip":"::1","service":"agrocist-ivr","timestamp":"2025-10-07T15:29:02.962Z","userAgent":"at-voice-api/1.0"}
info: POST /recording {"body":{"callSessionState":"Active","callStartTime":"2025-10-07 15:28:09","callerCarrierName":"MTN","callerCountryCode":"234","callerNumber":"+2347046713891","destinationNumber":"+2342017001117","direction":"Inbound","isActive":"1","recordingUrl":"https://gigantic.keller-shockley.at-internal.com/0687bcf0282141a6af2957f0608e5096.mp3","sessionId":"ATVId_b459912a561e10e6fd61fd9e93741d1c"},"headers":{"content-length":"355","content-type":"application/x-www-form-urlencoded","host":"localhost:3000","proxy-connection":"Keep-Alive","user-agent":"at-voice-api/1.0","x-forwarded-for":"18.130.220.110","x-forwarded-host":"turbo-invention-56q6r66j7vc7797-3000.app.github.dev","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-scheme":"https","x-original-uri":"/voice/recording","x-real-ip":"18.130.220.110","x-request-id":"fdf6aee2be4d2595eb822d1f801c6cfb","x-scheme":"https"},"ip":"::1","service":"agrocist-ivr","timestamp":"2025-10-07T15:29:02.962Z"}
info: === RECORDING WEBHOOK === {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:02.963Z"}
info: Full webhook data: {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:02.963Z"}
info: Recording received - Session: ATVId_b459912a561e10e6fd61fd9e93741d1c, Active: 1, URL: https://gigantic.keller-shockley.at-internal.com/0687bcf0282141a6af2957f0608e5096.mp3, Duration: undefineds {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:02.963Z"}
info: üöÄ Starting background AI processing for session: ATVId_b459912a561e10e6fd61fd9e93741d1c {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:02.963Z"}
info: ‚ö° Starting transcription for session ATVId_b459912a561e10e6fd61fd9e93741d1c {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:02.964Z"}
info: üé§ SENDING PROCESSING MESSAGE: {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:02.996Z"}
info: ‚ö° Audio downloaded in 416ms {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:03.380Z"}
info: ‚ö° Audio transcribed in 2564ms (total: 3083ms): "So my chicken are having bloody poo. I have used anticoxidant, but the bloody poo has not stopped. So what can I use again? Please. Two of them have died yesterday." {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:06.047Z"}
info: ‚ö° Transcription completed in 3083ms: "So my chicken are having bloody poo. I have used anticoxidant, but the bloody poo has not stopped. So what can I use again? Please. Two of them have died yesterday." {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:06.047Z"}
info: ‚ö° Starting AI processing for session ATVId_b459912a561e10e6fd61fd9e93741d1c {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:06.047Z"}
info: ‚ö° Starting AI query with model: gpt-4o-mini {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:06.048Z"}
info: ‚ö° AI processed veterinary query in 4495ms with confidence: 0.8 {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:10.543Z"}
info: ‚ö° AI processing completed in 4497ms {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:10.544Z"}
info: ‚ö° Starting TTS generation for session ATVId_b459912a561e10e6fd61fd9e93741d1c {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:10.544Z"}
info: Authenticating with DSN API... {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:10.545Z"}
info: DSN authentication successful, token expires: Tue Oct 07 2025 16:29:11 GMT+0000 (Coordinated Universal Time) {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:11.325Z"}
info: Saved DSN TTS audio: 172de14bc26976f2051f1b0c72ee3b92.wav (1072878 bytes) {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:14.032Z"}
info: Compressed 172de14bc26976f2051f1b0c72ee3b92.wav: 1072878 ‚Üí 89937 bytes (91.6% reduction) {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:14.189Z"}
warn: Audio file 172de14bc26976f2051f1b0c72ee3b92_compressed.mp3 is large (89937 bytes), may cause playback issues {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:14.190Z"}
info: Generated HTTPS URL for TTS audio: https://turbo-invention-56q6r66j7vc7797-3000.app.github.dev/audio/172de14bc26976f2051f1b0c72ee3b92_compressed.mp3 (89937 bytes) {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:14.190Z"}
info: Generated DSN TTS audio for en: Your chickens may have coccidiosis. Start by givin... {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:14.190Z"}
info: ‚ö° Background processing completed in 11226ms (Transcription: 3083ms, AI: 4497ms, TTS: 3646ms) {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:14.190Z"}
info: POST /voice/process-ai?session=ATVId_b459912a561e10e6fd61fd9e93741d1c {"ip":"::1","service":"agrocist-ivr","timestamp":"2025-10-07T15:29:20.061Z","userAgent":"at-voice-api/1.0"}
info: POST /process-ai {"body":{"callSessionState":"Active","callStartTime":"2025-10-07 15:28:09","callerCarrierName":"MTN","callerCountryCode":"234","callerNumber":"+2347046713891","destinationNumber":"+2342017001117","direction":"Inbound","isActive":"1","sessionId":"ATVId_b459912a561e10e6fd61fd9e93741d1c"},"headers":{"content-length":"248","content-type":"application/x-www-form-urlencoded","host":"localhost:3000","proxy-connection":"Keep-Alive","user-agent":"at-voice-api/1.0","x-forwarded-for":"18.130.220.110","x-forwarded-host":"turbo-invention-56q6r66j7vc7797-3000.app.github.dev","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-scheme":"https","x-original-uri":"/voice/process-ai?session=ATVId_b459912a561e10e6fd61fd9e93741d1c","x-real-ip":"18.130.220.110","x-request-id":"cb5d4e5a1cd96da4e468ec88f8b2f3df","x-scheme":"https"},"ip":"::1","service":"agrocist-ivr","timestamp":"2025-10-07T15:29:20.061Z"}
info: ü§ñ CHECKING AI RESULTS for session: ATVId_b459912a561e10e6fd61fd9e93741d1c {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:20.062Z"}
info: ‚úÖ AI response already ready for session ATVId_b459912a561e10e6fd61fd9e93741d1c {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:20.062Z"}
info: üé§ SENDING CACHED AI RESPONSE XML {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:20.062Z"}
info: POST /voice/end {"ip":"::1","service":"agrocist-ivr","timestamp":"2025-10-07T15:29:20.395Z","userAgent":"at-voice-api/1.0"}
info: POST /end {"body":{"amount":"3.54999999999999990","callSessionState":"Completed","callStartTime":"2025-10-07 15:28:09","callerCarrierName":"MTN","callerCountryCode":"234","callerNumber":"+2347046713891","currencyCode":"NGN","destinationNumber":"+2342017001117","direction":"Inbound","durationInSeconds":"71","isActive":"0","sessionId":"ATVId_b459912a561e10e6fd61fd9e93741d1c","status":"Aborted"},"headers":{"content-length":"331","content-type":"application/x-www-form-urlencoded","host":"localhost:3000","proxy-connection":"Keep-Alive","user-agent":"at-voice-api/1.0","x-forwarded-for":"18.130.220.110","x-forwarded-host":"turbo-invention-56q6r66j7vc7797-3000.app.github.dev","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-scheme":"https","x-original-uri":"/voice/end","x-real-ip":"18.130.220.110","x-request-id":"c075f242de7220b71972feced51e7c06","x-scheme":"https"},"ip":"::1","service":"agrocist-ivr","timestamp":"2025-10-07T15:29:20.396Z"}
info: POST /voice/process-ai?session=ATVId_b459912a561e10e6fd61fd9e93741d1c {"ip":"::1","service":"agrocist-ivr","timestamp":"2025-10-07T15:29:20.403Z","userAgent":"at-voice-api/1.0"}
info: POST /process-ai {"body":{"amount":"3.54999999999999990","callSessionState":"Completed","callStartTime":"2025-10-07 15:28:09","callerCarrierName":"MTN","callerCountryCode":"234","callerNumber":"+2347046713891","currencyCode":"NGN","destinationNumber":"+2342017001117","direction":"Inbound","durationInSeconds":"71","isActive":"0","sessionId":"ATVId_b459912a561e10e6fd61fd9e93741d1c","status":"Aborted"},"headers":{"content-length":"331","content-type":"application/x-www-form-urlencoded","host":"localhost:3000","proxy-connection":"Keep-Alive","user-agent":"at-voice-api/1.0","x-forwarded-for":"18.130.220.110","x-forwarded-host":"turbo-invention-56q6r66j7vc7797-3000.app.github.dev","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-scheme":"https","x-original-uri":"/voice/process-ai?session=ATVId_b459912a561e10e6fd61fd9e93741d1c","x-real-ip":"18.130.220.110","x-request-id":"fc6604f4779566e7fee7b597e5aa8b9d","x-scheme":"https"},"ip":"::1","service":"agrocist-ivr","timestamp":"2025-10-07T15:29:20.404Z"}
info: ü§ñ CHECKING AI RESULTS for session: ATVId_b459912a561e10e6fd61fd9e93741d1c {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:20.404Z"}
info: ‚úÖ AI response already ready for session ATVId_b459912a561e10e6fd61fd9e93741d1c {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:20.405Z"}
info: üé§ SENDING CACHED AI RESPONSE XML {"service":"agrocist-ivr","timestamp":"2025-10-07T15:29:20.405Z"}
Excellent progress! The system is now working perfectly - it transcribed your recording, processed it with AI, and generated a response! But the call is hanging up because the XML response isn't being logged. Looking at the logs:
‚úÖ AI response already ready for session ATVId_b459912a561e10e6fd61fd9e93741d1c
üé§ SENDING CACHED AI RESPONSE XML
But I don't see the actual XML! Let me add logging to see what's being sent:
Edit voiceController.ts
‚éø
Added 1 line
Session limit reached ‚àô resets 7pm